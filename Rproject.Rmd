---
title: "modelling"
author: "Gustav Helms"
date: "11/15/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#loading packages
pacman::p_load(tidyverse, quanteda, quanteda.corpora, seededlda, stopwords, stringdist)
```

```{r}
# Loading the data
df <- read_csv("TripReviews.csv", col_names = c("Restaurant", "Username", "ratingDate", "text", "rating"))
```


# -------------------------------------- Preproccesing -------------------------------------

```{r}
# Removing duplicates and removing all restaurants with less than 5 reviews
df <-   df %>% distinct(text, .keep_all = TRUE) %>% group_by(Restaurant) %>% filter(n() >= 5)
```

```{r, fig.height=15, fig.width=15}
##################################### Correcting errors in restaurant names ############################
# Creating stringdist matrix for restaurant names
distmatrix<-stringdistmatrix(unique(df$Restaurant),unique(df$Restaurant), useNames=TRUE ,method = "osa")

# Plotting heatmap of distances
heatmap(distmatrix)
```
```{r}
# Converting to dataframe
distmatrixdf<- as.data.frame(distmatrix)

# Making a row with restaurant names
distmatrixdf$Restaurant_Name <- rownames(distmatrixdf)

# Filtering out all links with less than 5 in distance and eyeballing the results to decide what links to merge
dist <- distmatrixdf %>% pivot_longer(cols = everything(vars = distmatrixdf$Restaurant_Name)) %>% filter(value <= 5 & value != 0)

# Correcting errors
df <- df %>% mutate(
  Restaurant = ifelse(Restaurant == "Brasserie Landal Sohojlandet", "Brasserie Landal Søhøjlandet", Restaurant),
  Restaurant = ifelse(Restaurant == "Jensens Bofhus Silkeborg", "Jensens Bøfhus Silkeborg", Restaurant),
  Restaurant = ifelse(Restaurant == "KiK", "Café KiK", Restaurant),
  Restaurant = ifelse(Restaurant == "Cafe Den Go'e Fe Heksekosten", "Café Den Go'e Fe Heksekosten", Restaurant),
  Restaurant = ifelse(Restaurant == "Traktorstedet Ludvigslyst", "Traktørstedet Ludvigslyst", Restaurant),
  Restaurant = ifelse(Restaurant == "Traktorstedet Ludvigslyst", "Traktørstedet Ludvigslyst", Restaurant)
)
```

# ---------------------------------- Analysis ----------------------------------------------
```{r}
corpuseret <- corpus(df$text)
toks_news <- tokens(corpuseret, remove_punct = TRUE, remove_numbers = TRUE, remove_symbol = TRUE)
toks_news <- tokens_remove(toks_news, pattern = c(stopwords("da")))
dfmat_news <- dfm(toks_news) %>% 
              dfm_trim(min_termfreq = 0.8, termfreq_type = "quantile",
                       max_docfreq = 0.1, docfreq_type = "prop")
```

```{r}
tmod_lda <- textmodel_lda(dfmat_news, k = 5)

terms(tmod_lda, 20)
```
```{r}

```

